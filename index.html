<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友拆帳助手</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 將 Firebase 實例掛載到 window 供 React 使用
        window.FB = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 從 window 取得 Firebase 函數
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch } = window.FB;

        // 配置資訊
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'expense-splitter-v2';

        const App = () => {
            const [user, setUser] = useState(null);
            const [activeUid, setActiveUid] = useState(null);
            const [view, setView] = useState('list'); // list, active, settings
            const [books, setBooks] = useState([]);
            const [currentBook, setCurrentBook] = useState(null);
            const [expenses, setExpenses] = useState([]);
            const [error, setError] = useState("");

            // 1. 初始化驗證
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Error", e);
                        setError("驗證失敗，請重新載入");
                    }
                };
                initAuth();
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) setActiveUid(u.uid);
                });
            }, []);

            // 2. 監聽帳本列表
            useEffect(() => {
                if (!user || !activeUid) return;
                const q = collection(db, 'artifacts', appId, 'users', activeUid, 'books');
                return onSnapshot(q, (snapshot) => {
                    const b = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBooks(b);
                }, (err) => setError("讀取帳本失敗"));
            }, [user, activeUid]);

            // 3. 監聽目前帳本的支出
            useEffect(() => {
                if (!user || !activeUid || !currentBook) return;
                const q = collection(db, 'artifacts', appId, 'users', activeUid, 'books', currentBook.id, 'expenses');
                return onSnapshot(q, (snapshot) => {
                    const e = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExpenses(e);
                }, (err) => setError("讀取支出失敗"));
            }, [user, activeUid, currentBook]);

            const handleCreateBook = async (name) => {
                if (!user || activeUid !== user.uid) {
                    setError("權限不足：無法在他人帳號建立帳本");
                    return;
                }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', activeUid, 'books'), {
                        name,
                        participants: ['我', '朋友'],
                        createdAt: Date.now()
                    });
                } catch (e) {
                    setError("建立失敗");
                }
            };

            return (
                <div className="min-h-screen p-4 max-w-md mx-auto">
                    <header className="flex justify-between items-center mb-6 pt-4">
                        <h1 className="text-2xl font-bold text-slate-800">拆帳助手</h1>
                        <div className="text-xs bg-white px-2 py-1 rounded shadow-sm text-slate-500">
                            ID: {activeUid?.slice(0, 8)}
                        </div>
                    </header>

                    {error && (
                        <div className="bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-sm flex justify-between">
                            {error}
                            <button onClick={() => setError("")}>✕</button>
                        </div>
                    )}

                    {view === 'list' && (
                        <div className="space-y-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <h2 className="font-medium mb-3">我的帳本</h2>
                                {books.length === 0 ? (
                                    <p className="text-slate-400 text-sm text-center py-4">尚無帳本，開始建立一個吧！</p>
                                ) : (
                                    books.map(book => (
                                        <div 
                                            key={book.id} 
                                            onClick={() => { setCurrentBook(book); setView('active'); }}
                                            className="p-3 mb-2 bg-slate-50 rounded-xl hover:bg-slate-100 cursor-pointer flex justify-between items-center transition-all"
                                        >
                                            <span className="font-medium">{book.name}</span>
                                            <span className="text-xs text-slate-400">{book.participants?.length} 人</span>
                                        </div>
                                    ))
                                )}
                                <button 
                                    onClick={() => {
                                        const name = prompt("請輸入帳本名稱：");
                                        if (name) handleCreateBook(name);
                                    }}
                                    className="w-full mt-4 py-3 bg-indigo-600 text-white rounded-xl font-medium shadow-lg shadow-indigo-100"
                                >
                                    + 新增帳本
                                </button>
                            </div>
                        </div>
                    )}

                    {view === 'active' && currentBook && (
                        <div>
                            <button onClick={() => setView('list')} className="text-indigo-600 text-sm mb-4">← 返回列表</button>
                            <div className="bg-white p-6 rounded-3xl shadow-xl">
                                <h2 className="text-xl font-bold mb-1">{currentBook.name}</h2>
                                <p className="text-slate-400 text-xs mb-4">參與者：{currentBook.participants?.join(', ')}</p>
                                
                                <div className="space-y-3">
                                    {expenses.map(exp => (
                                        <div key={exp.id} className="flex justify-between items-center p-3 border-b border-slate-50">
                                            <div>
                                                <div className="font-medium">{exp.title}</div>
                                                <div className="text-xs text-slate-400">{exp.payer} 付款</div>
                                            </div>
                                            <div className="font-bold text-indigo-600">${exp.amount}</div>
                                        </div>
                                    ))}
                                </div>

                                <button 
                                    onClick={async () => {
                                        const title = prompt("品項：");
                                        const amount = prompt("金額：");
                                        if (title && amount) {
                                            await addDoc(collection(db, 'artifacts', appId, 'users', activeUid, 'books', currentBook.id, 'expenses'), {
                                                title,
                                                amount: Number(amount),
                                                payer: '我',
                                                timestamp: Date.now()
                                            });
                                        }
                                    }}
                                    className="w-full mt-6 py-3 border-2 border-dashed border-slate-200 text-slate-400 rounded-xl hover:bg-slate-50"
                                >
                                    + 新增支出項目
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
