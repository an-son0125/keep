<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友拆帳助手 - 穩定修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F5F5F5; color: #576F72; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .input-focus:focus { outline: none; box-shadow: 0 0 0 2px rgba(142, 151, 117, 0.2); }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center pb-20">
        <!-- Header -->
        <header class="w-full bg-white border-b sticky top-0 z-30 px-4 py-4 shadow-sm flex justify-center">
            <div class="w-full max-w-5xl flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i data-lucide="folder-kanban" id="header-icon" class="w-5 h-5 text-[#8E9775]"></i>
                    <button id="book-title-btn" onclick="showView('books')" class="text-sm font-black hover:opacity-70 transition-opacity">載入中...</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-active" onclick="showView('active')" class="px-3 py-1.5 text-xs font-bold rounded-lg bg-[#f1f1f1] text-[#40514E]">現行</button>
                    <button id="btn-history" onclick="showView('history')" class="px-3 py-1.5 text-xs font-bold rounded-lg text-slate-400">歷史</button>
                    <button onclick="toggleModal('sync-modal', true)" class="p-2 text-slate-400 hover:text-slate-600"><i data-lucide="cloud" class="w-5 h-5"></i></button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="w-full max-w-xl p-4 md:p-8 space-y-6">
            <div class="py-20 text-center text-slate-400 font-bold">系統初始化中...</div>
        </main>

        <!-- Sync Modal -->
        <div id="sync-modal" class="fixed inset-0 z-[150] bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-black text-lg flex items-center gap-2"><i data-lucide="cloud"></i> 雲端同步</h3>
                    <button onclick="toggleModal('sync-modal', false)"><i data-lucide="x"></i></button>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">當前同步 ID</p>
                    <div class="flex items-center gap-2 mt-1">
                        <code id="display-account-key" class="bg-white px-2 py-1 rounded border flex-1 text-xs font-mono font-bold text-center">---</code>
                    </div>
                </div>
                <input id="input-sync-key" placeholder="貼上好友的 ID..." class="w-full bg-slate-100 p-3 rounded-xl text-sm input-focus">
                <button onclick="changeSyncKey()" class="w-full text-white py-3 rounded-xl font-bold text-sm bg-[#40514E]">切換 ID</button>
            </div>
        </div>

        <!-- Receipt Modal -->
        <div id="receipt-modal" class="fixed inset-0 z-[100] bg-black/70 backdrop-blur-md hidden items-center justify-center p-4">
            <div id="receipt-container" class="w-full max-w-sm flex flex-col gap-4"></div>
        </div>

        <div id="toast" class="fixed bottom-10 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl font-bold hidden z-[200]"></div>
    </div>

    <script>
        // --- 1. 初始化 Firebase 變數 ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'expense_splitter_v2';
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. 應用程式狀態 ---
        let state = {
            isReady: false,
            accountKey: localStorage.getItem('expense_account_key') || Math.random().toString(36).substr(2, 9),
            view: 'books',
            books: [],
            currentBookId: null,
            expenses: [],
            settlements: [],
            selectedPayer: '我',
            isAddingBook: false
        };

        // --- 3. 核心功能：獲取合法路徑 ---
        function getBooksRef() {
            // 必須遵守 /artifacts/{appId}/users/{userId}/{collection}
            return db.collection('artifacts').doc(appId).collection('users').doc(state.accountKey).collection('books');
        }

        // --- 4. 登入與初始化 ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("登入成功:", user.uid);
                state.isReady = true;
                initApp();
            } else {
                console.log("嘗試匿名登入...");
                try {
                    await auth.signInAnonymously();
                } catch (e) {
                    showToast("登入系統失敗，請重新整理");
                }
            }
        });

        function initApp() {
            localStorage.setItem('expense_account_key', state.accountKey);
            document.getElementById('display-account-key').innerText = state.accountKey;
            
            // 監聽帳本清單
            getBooksRef().onSnapshot(snap => {
                state.books = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!state.currentBookId && state.books.length > 0) {
                    state.currentBookId = state.books[0].id;
                }
                if (state.currentBookId) loadBookData();
                render();
            }, err => {
                console.error("讀取帳本失敗:", err);
                showToast("讀取雲端失敗");
            });
        }

        let unsubExp = null;
        let unsubSet = null;
        function loadBookData() {
            if (unsubExp) unsubExp();
            if (unsubSet) unsubSet();

            const bookRef = getBooksRef().doc(state.currentBookId);

            unsubExp = bookRef.collection('expenses').onSnapshot(snap => {
                const all = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.expenses = all.filter(e => e.status !== 'settled').sort((a, b) => b.timestamp - a.timestamp);
                render();
            });

            unsubSet = bookRef.collection('settlements').onSnapshot(snap => {
                state.settlements = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.settledAt - a.settledAt);
                render();
            });
        }

        // --- 5. 操作函式 (Async 修復) ---
        async function handleAddBook() {
            if (!state.isReady) return showToast("系統尚未準備就緒");
            
            const nameInput = document.getElementById('new-book-name');
            const name = nameInput ? nameInput.value.trim() : "";
            
            if (!name) return showToast("請輸入帳本名稱");

            try {
                showToast("建立中...");
                // 執行寫入
                const docRef = await getBooksRef().add({
                    name: name,
                    participants: ['我', '朋友'],
                    createdAt: Date.now()
                });
                
                state.currentBookId = docRef.id;
                state.isAddingBook = false;
                state.view = 'active';
                showToast("帳本建立成功！");
            } catch (e) {
                console.error("寫入錯誤細節:", e);
                showToast("建立失敗：權限或路徑錯誤");
            }
        }

        async function handleAddExpense() {
            const name = document.getElementById('exp-name').value;
            const amount = document.getElementById('exp-amount').value;
            if (!name || !amount) return showToast("請填寫品項與金額");

            try {
                await getBooksRef().doc(state.currentBookId).collection('expenses').add({
                    name: name,
                    amount: parseFloat(amount),
                    payer: state.selectedPayer,
                    status: 'active',
                    timestamp: Date.now()
                });
                document.getElementById('exp-name').value = '';
                document.getElementById('exp-amount').value = '';
                showToast("已紀錄");
            } catch (e) {
                showToast("新增失敗");
            }
        }

        // --- 6. 渲染 UI ---
        function showView(v) { state.view = v; render(); }

        function render() {
            const main = document.getElementById('main-content');
            const book = state.books.find(b => b.id === state.currentBookId);
            document.getElementById('book-title-btn').innerText = book ? book.name : '選擇帳本';

            if (state.view === 'books') renderBooks(main);
            else if (state.view === 'active') renderActive(main, book);
            else if (state.view === 'history') renderHistory(main);
            
            lucide.createIcons();
        }

        function renderBooks(container) {
            container.innerHTML = `
                <div class="animate-in space-y-4">
                    <div class="flex justify-between items-center">
                        <h2 class="font-black text-lg">我的帳本庫</h2>
                        <button onclick="state.isAddingBook=true; render();" class="bg-[#8E9775] text-white p-2 rounded-full"><i data-lucide="plus"></i></button>
                    </div>
                    ${state.isAddingBook ? `
                        <div class="bg-white p-6 rounded-3xl border shadow-sm space-y-4 animate-in">
                            <input id="new-book-name" placeholder="例如：日本旅行、晚餐拆帳" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold input-focus">
                            <div class="flex gap-2">
                                <button onclick="handleAddBook()" class="flex-1 bg-[#8E9775] text-white py-3 rounded-2xl font-bold">確認建立</button>
                                <button onclick="state.isAddingBook=false; render();" class="px-6 py-3 rounded-2xl font-bold bg-slate-100 text-slate-400">取消</button>
                            </div>
                        </div>
                    ` : ''}
                    <div class="grid gap-3">
                        ${state.books.length === 0 ? '<div class="py-10 text-center text-slate-300">尚未建立任何帳本</div>' : 
                          state.books.map(b => `
                            <div onclick="state.currentBookId='${b.id}'; loadBookData(); showView('active');" class="bg-white p-5 rounded-3xl border ${state.currentBookId === b.id ? 'border-slate-800 ring-2 ring-slate-100' : ''} cursor-pointer flex justify-between items-center">
                                <div><span class="font-black block">${b.name}</span><span class="text-[10px] text-slate-400 font-bold uppercase">${b.participants.length} 人</span></div>
                                <i data-lucide="chevron-right" class="text-slate-300"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderActive(container, book) {
            if (!book) {
                container.innerHTML = `<div class="py-20 text-center animate-in"><button onclick="showView('books')" class="font-black text-slate-400 border-b-2">點此先建立或選擇帳本</button></div>`;
                return;
            }
            const total = state.expenses.reduce((s, i) => s + i.amount, 0);
            container.innerHTML = `
                <div class="animate-in space-y-6">
                    <div class="bg-white p-6 rounded-3xl border">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">成員</p>
                        <div class="flex flex-wrap gap-2">
                            ${book.participants.map(p => `<div class="bg-slate-100 px-4 py-2 rounded-2xl text-xs font-bold">${p}</div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border space-y-4 shadow-sm">
                        <input id="exp-name" placeholder="品項名稱" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold input-focus">
                        <input id="exp-amount" type="number" placeholder="金額" class="w-full bg-slate-50 p-4 rounded-2xl text-sm font-bold input-focus">
                        <div class="flex flex-wrap gap-2">
                            ${book.participants.map(p => `
                                <button onclick="state.selectedPayer='${p}'; render();" class="px-4 py-2 rounded-2xl text-xs font-bold border-2 ${state.selectedPayer === p ? 'bg-[#8E9775] text-white border-[#8E9775]' : 'bg-white text-slate-400 border-slate-100'}">${p}</button>
                            `).join('')}
                        </div>
                        <button onclick="handleAddExpense()" class="w-full bg-[#40514E] text-white py-4 rounded-2xl font-black text-sm">新增紀錄</button>
                    </div>
                    <div class="bg-[#40514E] rounded-[2.5rem] overflow-hidden text-white shadow-2xl">
                        <div class="p-8">
                            <p class="text-[10px] opacity-50 mb-1 font-black">總支出</p>
                            <h2 class="text-4xl font-black">$${total.toLocaleString()}</h2>
                        </div>
                        <div class="bg-white text-[#576F72] p-6 rounded-t-[2.5rem] space-y-4 min-h-[200px]">
                            ${state.expenses.length === 0 ? '<p class="text-center text-slate-300 py-10">尚無支出紀錄</p>' : 
                                state.expenses.map(e => `
                                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                                        <div><span class="text-sm font-black block">${e.name}</span><span class="text-[10px] text-slate-400 font-bold">${e.payer} 支付</span></div>
                                        <span class="font-black text-sm">$${e.amount.toLocaleString()}</span>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistory(container) {
            if (state.settlements.length === 0) {
                container.innerHTML = `<div class="py-20 text-center text-slate-300">目前無歷史結算紀錄</div>`;
                return;
            }
            container.innerHTML = `<div class="space-y-4 animate-in">${state.settlements.map(s => `
                <div class="bg-white p-6 rounded-3xl border flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-black text-slate-400">${new Date(s.settledAt).toLocaleDateString()}</p>
                        <p class="font-black text-[#40514E]">${s.bookName}</p>
                    </div>
                    <p class="text-xl font-black">$${s.totalSpent.toLocaleString()}</p>
                </div>
            `).join('')}</div>`;
        }

        // --- 7. 雜項輔助 ---
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2000);
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden', !show);
            el.classList.toggle('flex', show);
        }

        function changeSyncKey() {
            const k = document.getElementById('input-sync-key').value.trim();
            if (k.length > 5) {
                state.accountKey = k;
                localStorage.setItem('expense_account_key', k);
                location.reload();
            }
        }
    </script>
</body>
</html>
